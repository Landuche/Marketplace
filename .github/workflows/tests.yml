name: CI/CD Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  full-stack-validation:
    name: Backend Validation Orchestrated With Docker
    runs-on: ubuntu-latest
    env:
      DEBUG: ${{ secrets.DEBUG || '1' }}  
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS || '*' }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      REDIS_URL: ${{ secrets.REDIS_URL || 'redis://redis:6379' }}
      STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
      VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
      VITE_API_URL: ${{ secrets.VITE_API_URL || '/api/' }} 
      VITE_GOOGLE_MAPS_KEY: ${{ secrets.VITE_GOOGLE_MAPS_KEY }}
      VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
      VITE_SENTRY_ENV: ${{ secrets.VITE_SENTRY_ENV }}
      VITE_SENTRY_AUTH: ${{ secrets.VITE_SENTRY_AUTH }}

    
    steps:
      - uses: actions/checkout@v4

      - name: Build Stack
        run: docker compose up -d --build

      - name: Run Playright
        run: docker compose run --rm playwright

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright/playwright-report/
          retention-days: 30

      - name: Run Pytest
        run: docker compose exec -T web pytest -v -s

      - name: Run Swagger Validation
        run: |
          docker compose exec -T web python manage.py spectacular --file schema_generated.yml
          docker compose exec -T web diff schema.yml schema_generated.yml

      - name: Dump Docker Logs
        if: failure()
        run: docker compose logs --tail=100

      - name: Stop Docker
        if: always()
        run: docker compose down -v